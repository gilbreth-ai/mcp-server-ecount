# ECOUNT OpenAPI 분석 및 주의사항

## 1. 인증 체계

### 인증키 발급 절차
```
테스트 인증키 발급 → 개발 검증 → 실제 인증키 발급 → 로그인 API → 업무 API
```

### 인증키 종류
| 구분 | 유효기간 | 발급 조건 | 비고 |
|------|----------|-----------|------|
| 테스트 인증키 | 2주 | 마스터 ID만 | 최대 3회 갱신, 검증용 |
| 실제 인증키 | 1년 | 검증 완료 후 | 갱신 필요 |

### 세션 관리
- 세션 ID는 ERP 자동로그아웃 설정 시간 동안 유효
- API 호출 시마다 타이머 리셋
- 미호출 시 세션 만료 → 재로그인 필요

---

## 2. Rate Limit (⚠️ 핵심 제약사항)

### API별 전송 기준

| API 종류 | 실서버 | 테스트서버 |
|----------|--------|-----------|
| Zone 조회 | **1회/10분** | 1회/10초 |
| 로그인 | **1회/10분** | 1회/10초 |
| 조회 (발주서, 품목, 재고현황 등) | **1회/10분** | 1회/10초 |
| 저장 (거래처, 품목, 전표 입력 등) | 1회/10초 | 1회/10초 |
| 단건 조회 (품목, 재고) | 1회/1초 | 1회/1초 |

### 오류 및 허용량 제한

| 제한 항목 | 값 |
|-----------|-----|
| 시간당 연속 오류 제한 | 30건 |
| 1회 최대 허용량 | 300건 |
| 1일 최대 허용량 | 5,000건 |

### Rate Limit 초과 시
- HTTP 302 또는 412 응답
- API 호출 차단

---

## 3. MCP 개발 시 문제가 될 수 있는 부분

### 🔴 심각 (반드시 해결 필요)

#### 1. Zone/로그인 Rate Limit (10분에 1회)
**문제**: MCP 서버가 재시작되거나 세션 만료 시 로그인이 필요한데, 10분에 1회만 가능
**해결책**:
- Zone은 최초 1회만 조회 후 영구 캐싱 (회사별 고정값)
- 세션 ID를 파일/환경변수로 저장하여 서버 재시작 시에도 유지
- 세션 만료 전 주기적으로 API 호출하여 세션 연장

#### 2. 조회 API Rate Limit (10분에 1회)
**문제**: 품목 조회, 재고 조회 등이 10분에 1회만 가능
**해결책**:
- 응답 캐싱 (TTL: 10분)
- 단건 조회 API 활용 (1초에 1회 가능)
- 배치 요청 대신 필요한 데이터만 조회

#### 3. 연속 오류 30건 제한
**문제**: 버그나 잘못된 요청이 반복되면 차단
**해결책**:
- 입력값 철저한 유효성 검사
- 에러 발생 시 즉시 중단 (재시도 제한)
- 에러 카운터 구현하여 30건 근접 시 경고

### 🟡 주의 (사용자 안내 필요)

#### 4. 테스트 인증키 검증 절차
**문제**: 오픈소스 사용자들이 각자 검증 절차를 거쳐야 함
**해결책**:
- README에 검증 절차 상세 안내
- 테스트 환경 설정 가이드 제공

#### 5. 인증키 1년 만료
**문제**: 사용자가 매년 갱신해야 함
**해결책**:
- 세션 에러 시 친절한 안내 메시지
- 인증키 만료 가능성 경고

#### 6. IP 차단 설정 호환성
**문제**: ERP에서 IP 차단 설정 시 MCP 서버 접근 불가
**해결책**:
- README에 IP 설정 관련 주의사항 안내
- 에러 메시지에 IP 차단 가능성 언급

#### 7. 마스터 ID 전용
**문제**: 일반 사용자 ID로는 인증키 발급 불가
**해결책**:
- README에 명시
- 권한 관련 에러 시 안내

### 🟢 경미 (인지만 필요)

#### 8. 미납 시 차단
- 가입비/사용료 미납 시 세션 발급 불가
- 에러 메시지로 안내

#### 9. 웹자료올리기 설정 필요
- 입력 API 사용 시 ERP에서 웹자료올리기 항목 추가 필요
- README에 설정 방법 안내

#### 10. 서비스 제한 가능성
- "트래픽 초과로 인해 시스템에 부하가 발생하거나 기타 등의 이유로 제한될 수 있습니다"
- 오픈소스로 배포 시 다수 사용자가 동시에 사용하면 문제될 수 있음

---

## 4. HTTP 상태코드

| Status | 설명 |
|--------|------|
| 200 | 정상 (성공/실패 모두 가능, Result 필드 확인) |
| 302 | Rate Limit 초과 |
| 404 | 잘못된 API path |
| 412 | Rate Limit 초과 |
| 500 | 내부 시스템 오류 |

### 응답 구조
```json
{
  "Status": 200,
  "Result": "성공/실패",
  "Message": "...",
  "Data": { ... },
  "TRACE_ID": "..."  // 오류 문의 시 필요
}
```

---

## 5. MCP 설계 권장사항

### 캐싱 전략
```typescript
const CACHE_TTL = {
  zone: Infinity,        // 영구 캐싱 (회사별 고정)
  session: '세션유효시간', // ERP 설정값
  products: 10 * 60,     // 10분 (Rate Limit 맞춤)
  inventory: 10 * 60,    // 10분
  singleItem: 1,         // 1초 (단건 조회)
};
```

### Rate Limiter 구현
```typescript
const RATE_LIMITS = {
  zone: { calls: 1, per: 10 * 60 * 1000 },      // 10분
  login: { calls: 1, per: 10 * 60 * 1000 },     // 10분
  query: { calls: 1, per: 10 * 60 * 1000 },     // 10분
  save: { calls: 1, per: 10 * 1000 },           // 10초
  singleQuery: { calls: 1, per: 1000 },         // 1초
};
```

### 에러 카운터
```typescript
class ErrorCounter {
  private errorCount = 0;
  private readonly MAX_ERRORS = 25; // 30보다 여유있게

  recordError() {
    this.errorCount++;
    if (this.errorCount >= this.MAX_ERRORS) {
      throw new Error('연속 오류 한도 근접. 잠시 후 다시 시도하세요.');
    }
  }

  resetOnSuccess() {
    this.errorCount = 0;
  }
}
```

---

## 6. 오픈소스 배포 시 법적/정책적 고려사항

### 확인 필요 사항
- [ ] 이카운트 OpenAPI 이용약관에서 써드파티 라이브러리 배포 허용 여부
- [ ] API 래퍼 라이브러리가 "재배포"에 해당하는지
- [ ] 상업적 사용 가능 여부

### 권장 조치
1. 이카운트 고객지원에 공식 문의
2. README에 면책 조항 추가
3. 라이선스에 "이카운트 이용약관 준수" 명시

### 면책 조항 예시
```markdown
## 면책 조항

이 프로젝트는 이카운트와 공식적인 관계가 없는 커뮤니티 프로젝트입니다.
이카운트 OpenAPI를 사용하려면 이카운트 계정과 유효한 API 인증키가 필요합니다.
API 사용에 관한 모든 책임은 사용자에게 있으며, 이카운트의 이용약관을 준수해야 합니다.
```

---

## 7. API 엔드포인트 정보

### 서버 URL
| 환경 | URL | 비고 |
|------|-----|------|
| Zone 조회 | `https://oapi.ecount.com/OAPI/V2/Zone` | |
| 테스트 | `https://sboapi{zone}.ecount.com` | zone 소문자 |
| 실서버 | `https://oapi{zone}.ecount.com` | zone 소문자 (BB → bb) |

### 세션 전달 방식
- SESSION_ID는 **URL 쿼리 파라미터**로 전달: `?SESSION_ID={sessionId}`
- Body에 SESSION_ID를 넣으면 동작하지 않음

### 검증된 API 엔드포인트 (실제 동작 확인)
| 카테고리 | API 명 | 엔드포인트 | Rate Limit |
|----------|--------|-----------|------------|
| 인증 | Zone 조회 | `/OAPI/V2/Zone` | 10분/1회 |
| 인증 | 로그인 | `/OAPI/V2/OAPILogin` | 10분/1회 |
| 품목 | 품목 다건 조회 | `/OAPI/V2/InventoryBasic/GetBasicProductsList` | 10분/1회 |
| 재고 | 재고현황 다건 | `/OAPI/V2/InventoryBalance/GetListInventoryBalanceStatus` | 10분/1회 |

### 미검증 API (문서 기반)
| 카테고리 | API |
|----------|-----|
| 조회 | 발주서조회, 창고별재고현황 |
| 조회(단건) | 품목조회(단건), 재고현황(단건), 창고별재고현황(단건) |
| 저장 | 거래처등록, 품목등록, 견적서입력, 주문서입력, 판매입력, 구매입력 |
| 저장 | 작업지시서입력, 생산불출입력, 생산입고I |
| 회계 | 매출·매입전표 II 자동분개 |
| 쇼핑몰 | 주문API |
| 기타 | 게시판 |

---

## 8. 다음 단계

1. 사용자로부터 상세 API 스펙 수집 (엔드포인트, 파라미터, 응답 형식)
2. Rate Limit을 고려한 MCP Tool 설계
3. 캐싱 및 에러 처리 구현
4. 이카운트 정책 확인 (선택적)
